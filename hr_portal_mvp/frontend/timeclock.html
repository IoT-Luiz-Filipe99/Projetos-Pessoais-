<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ponto Mobile</title>
  <link rel="stylesheet" href="./styles.css">
  <script defer src="./utils.js"></script>
</head>
<body onload="init()">
<header><h1>Portal do Colaborador</h1>
  <nav>
    <a href="./dashboard.html">Dashboard</a>
    <a href="./timeclock.html">Ponto</a>
    <a href="./chat.html">Chat</a>
    <a href="./training.html">Treinamentos</a>
    <a href="./reports.html">Relatórios</a>
  </nav>
</header>
<div class="container">
  <h2>Registro de Ponto</h2>
  <div class="list">
    <video id="video" autoplay playsinline style="width:100%;max-width:420px;border-radius:12px;border:1px solid #e5e7eb"></video>
    <button class="btn" id="btnSnap">Tirar selfie & Registrar</button>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
  </div>
  <h3>Meus registros</h3>
  <div id="entries" class="list"></div>
</div>
<script>
let stream;
async function init(){
  requireAuth();
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:true});
    document.getElementById("video").srcObject = stream;
  }catch(e){ alert("Câmera não permitida: " + e.message); }
  document.getElementById("btnSnap").onclick = registerPonto;
  loadEntries();
}
async function registerPonto(){
  if(!navigator.geolocation){ alert("Geolocalização não suportada"); return; }
  navigator.geolocation.getCurrentPosition(async (pos)=>{
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const blob = await new Promise(r=>canvas.toBlob(r,"image/jpeg",0.85));
    const fd = new FormData();
    fd.append("latitude", lat);
    fd.append("longitude", lng);
    fd.append("entry_type", "check_in");
    fd.append("photo", blob, "selfie.jpg");
    try{
      const token = getToken();
      const res = await fetch(API + "/time_entries", { method: "POST", headers: { "Authorization": "Bearer " + token }, body: fd });
      if(!res.ok){ throw new Error(await res.text()); }
      alert("Ponto registrado!");
      loadEntries();
    }catch(e){ alert("Erro ao registrar: " + e.message); }
  }, err=>alert("Erro de GPS: " + err.message), {enableHighAccuracy:true, timeout:10000});
}
async function loadEntries(){
  const rows = await api("/time_entries/my");
  document.getElementById("entries").innerHTML = rows.map(r=>`
    <div class="item">
      ${new Date(r.timestamp).toLocaleString()} • ${r.type} • (${r.lat.toFixed(5)}, ${r.lng.toFixed(5)})
      ${r.photo_url ? `<div><a class="btn" href="${r.photo_url}" target="_blank">Ver selfie</a></div>` : ""}
    </div>
  `).join("");
}
</script>
</body></html>
