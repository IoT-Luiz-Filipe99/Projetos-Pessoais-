<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Chat por Departamento</title>
  <link rel="stylesheet" href="./styles.css">
  <script defer src="./utils.js"></script>
</head>
<body onload="init()">
<header><h1>Portal do Colaborador</h1>
  <nav>
    <a href="./dashboard.html">Dashboard</a>
    <a href="./timeclock.html">Ponto</a>
    <a href="./chat.html">Chat</a>
    <a href="./training.html">Treinamentos</a>
    <a href="./reports.html">Relat√≥rios</a>
  </nav>
</header>
<div class="container">
  <h2>Chat por Departamento</h2>
  <div class="chat">
    <div id="messages" class="messages"></div>
    <div class="composer">
      <input id="msg" placeholder="Digite sua mensagem...">
      <button id="send" class="btn">Enviar</button>
    </div>
  </div>
</div>
<script>
let ws;
async function init(){
  requireAuth();
  const me = await loadMe();
  const token = getToken();
  const proto = location.protocol === "https:" ? "wss" : "ws";
  ws = new WebSocket(`${proto}://${location.host}/ws/chat/${encodeURIComponent(me.department)}?token=${encodeURIComponent(token)}`);
  ws.onmessage = (ev)=>{
    const data = JSON.parse(ev.data);
    const box = document.getElementById("messages");
    const who = data.system ? "Sistema" : data.user;
    const text = data.message || data.content;
    const line = document.createElement("div");
    line.innerHTML = `<b>${who}:</b> ${text}`;
    box.appendChild(line);
    box.scrollTop = box.scrollHeight;
  };
  document.getElementById("send").onclick = ()=>{
    const inp = document.getElementById("msg");
    const content = inp.value.trim();
    if(content){ ws.send(JSON.stringify({content})); inp.value=""; }
  };
}
</script>
</body></html>
